<div class="relative w-full text-sm group">
  <div (click)="toggleCalendar()"
    class="flex items-center justify-between w-full bg-[var(--bg-panel)] border border-[var(--border-light)] px-4 py-3 text-[var(--text-heading)] cursor-pointer hover:bg-[var(--bg-panel)]/80 transition-colors"
    [class.opacity-50]="isDisabled">
    <span [class.text-[var(--text-secondary)]]="!selectedDate()" class="uppercase tracking-widest text-xs">
      {{ selectedDate() ? formatDate(selectedDate()) : placeholder }}
    </span>
    <i class="pi pi-calendar text-[var(--text-secondary)] group-hover:text-sky-500 transition-colors"></i>
  </div>

  @if (isOpen()) {
  <div class="fixed inset-0 bg-[var(--bg-dark)]/80 backdrop-blur-sm z-[9990] md:hidden" (click)="closeCalendar()"></div>

  <div
    class="fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-[90%] max-w-[320px] z-[9999] md:absolute md:top-full md:left-0 md:translate-x-0 md:translate-y-0 md:w-full md:max-w-none bg-[var(--bg-dark)] border border-[var(--border-light)] shadow-[0_0_50px_rgba(0,0,0,0.9)] md:shadow-[0_10px_40px_-10px_rgba(0,0,0,0.8)] p-4 animate-fadeIn rounded-sm">
    <div class="flex justify-between items-center mb-4 pb-2 border-b border-[var(--border-light)]">
      <button type="button" (click)="changeMonth(-1)" class="p-2 hover:text-sky-400 transition-colors">
        <i class="pi pi-chevron-left text-xs"></i>
      </button>
      <span class="font-bold uppercase tracking-widest text-[var(--text-heading)] text-xs">
        {{ currentViewDate() | date : "MMMM yyyy" : "" : "es-VE" }}
      </span>
      <button type="button" (click)="changeMonth(1)" class="p-2 hover:text-sky-400 transition-colors">
        <i class="pi pi-chevron-right text-xs"></i>
      </button>
    </div>

    <div class="grid grid-cols-7 gap-1 mb-2 text-center">
      @for(day of ['DO','LU','MA','MI','JU','VI','SA']; track day) {
      <span class="text-xs text-[var(--text-secondary)] font-bold">{{ day }}</span>
      }
    </div>

    <div class="grid grid-cols-7 gap-1">
      @for(day of daysInMonth(); track $index) { @if(day) {
      <button type="button" (click)="selectDate(day)" [disabled]="isDateDisabled(day)"
        class="h-8 w-full flex items-center justify-center text-xs border border-transparent hover:border-sky-500/50 hover:bg-[var(--bg-panel)] transition-all relative rounded-sm"
        [class.bg-sky-500]="
          selectedDate()?.toDateString() === day.toDateString()
        " [class.text-[var(--btn-primary-text)]]="
          selectedDate()?.toDateString() === day.toDateString()
        " [class.font-bold]="
          selectedDate()?.toDateString() === day.toDateString()
        " [class.opacity-20]="isDateDisabled(day)" [class.cursor-not-allowed]="isDateDisabled(day)"
        [class.line-through]="isDateDisabled(day)">
        {{ day.getDate() }}
      </button>
      } @else {
      <span></span>
      } }
    </div>

    <div class="mt-4 pt-4 border-t border-[var(--border-light)] flex justify-between items-center">
      <span class="text-xs text-[var(--text-secondary)] uppercase tracking-widest">Hora</span>

      <div
        class="flex items-center gap-2 bg-[var(--bg-panel)] border border-[var(--border-light)] px-3 py-1 rounded-sm">
        <div class="flex flex-col items-center">
          <button type="button" (click)="updateTime('hour', 1)"
            class="text-xs text-[var(--text-secondary)] hover:text-sky-400 py-0.5">
            <i class="pi pi-chevron-up"></i>
          </button>
          <span class="font-bold text-[var(--text-heading)] w-5 text-center text-sm">{{ selectedHour() |
            number : "2.0"
            }}</span>
          <button type="button" (click)="updateTime('hour', -1)"
            class="text-xs text-[var(--text-secondary)] hover:text-sky-400 py-0.5">
            <i class="pi pi-chevron-down"></i>
          </button>
        </div>

        <span class="text-[var(--text-secondary)] pb-0.5">:</span>

        <div class="flex flex-col items-center">
          <button type="button" (click)="updateTime('minute', 30)"
            class="text-xs text-[var(--text-secondary)] hover:text-sky-400 py-0.5">
            <i class="pi pi-chevron-up"></i>
          </button>
          <span class="font-bold text-[var(--text-heading)] w-5 text-center text-sm">{{ selectedMinute() |
            number : "2.0"
            }}</span>
          <button type="button" (click)="updateTime('minute', -30)"
            class="text-xs text-[var(--text-secondary)] hover:text-sky-400 py-0.5">
            <i class="pi pi-chevron-down"></i>
          </button>
        </div>
      </div>
    </div>

    @if (unavailableHours().length > 0) {
    <div class="mt-4 pt-4 border-t border-[var(--border-light)]">
      <span class="text-xs text-red-400 uppercase tracking-widest block mb-2">
        Horas No Disponibles:
      </span>
      <div class="flex flex-wrap gap-2">
        @for (date of unavailableHours(); track $index) {
        <span class="text-xs bg-red-500/10 text-red-400 border border-red-500/20 px-2 py-1 rounded">
          {{ formatHour(date) }}
        </span>
        }
      </div>
    </div>
    }

    <button type="button" (click)="closeCalendar()"
      class="w-full mt-5 bg-[var(--bg-panel)] hover:bg-sky-500 hover:text-slate-950 text-sky-500 border border-[var(--border-light)] text-xs font-bold uppercase tracking-[0.2em] py-3 transition-all active:scale-[0.98]">
      Listo
    </button>
  </div>
  }
</div>