<div class="min-h-screen bg-[var(--bg-dark)] text-[var(--text-primary)] font-sans selection:bg-sky-500/30 pb-12">
    <!-- Header -->
    <div class="sticky top-0 z-30 bg-[var(--bg-dark)]/90 backdrop-blur-md border-b border-[var(--border-light)]">
        <div class="px-6 py-4 md:px-12 flex flex-col md:flex-row justify-between items-center gap-4">
            <div>
                <h1 class="text-xl md:text-2xl text-[var(--text-heading)] tracking-wide uppercase">
                    Registro de <span class="font-bold text-sky-500">Acciones</span>
                </h1>
                <p class="text-sm text-[var(--text-secondary)] uppercase tracking-[0.2em] mt-1">
                    Historial de Auditoría del Sistema
                </p>
            </div>

            <div
                class="flex items-center gap-3 bg-[var(--bg-panel)] px-4 py-2 rounded-full border border-[var(--border-light)]">
                <span class="w-2 h-2 rounded-full bg-emerald-500 animate-pulse"></span>
                <span class="text-xs text-[var(--text-primary)] uppercase">{{ totalLogs }} Registros</span>
            </div>
        </div>
    </div>

    <div class="px-6 md:px-12 py-8 animate-fade-in">
        <!-- Filters Section - Now using Shared Search Bar -->
        <div class="mb-6">
            <shared-search-bar (search)="onSearch($event)" [dropdownOptions]="actionOptions"
                placeholder="Buscar por Usuario..." label="Registro de Actividad" dropdownLabel="Filtrar Acción"
                buttonText="BUSCAR" [showAdvancedFilters]="true" [showDateFilters]="true" [showPriceFilters]="false"
                [sortOptions]="sortOptions" [currentSortBy]="sortBy" [currentSortOrder]="sortOrder">
            </shared-search-bar>
        </div>

        <!-- Loading State -->
        @if (loading()) {
        <div class="h-[50vh] flex flex-col items-center justify-center gap-4">
            <i class="pi pi-spin pi-spinner text-3xl text-sky-600"></i>
            <span class="text-xs text-[var(--text-secondary)] uppercase">Cargando Registros...</span>
        </div>
        } @else {

        <!-- Logs Table -->
        <div class="bg-[var(--bg-dark)] border border-[var(--border-light)] rounded-sm overflow-hidden">
            <div
                class="px-6 py-4 border-b border-[var(--border-light)] bg-[var(--bg-panel)] flex justify-between items-center">
                <h3
                    class="text-sm font-bold text-[var(--text-heading)] uppercase tracking-widest flex items-center gap-2">
                    <i class="pi pi-list"></i> Logs de Auditoría
                </h3>
                <span class="text-xs text-[var(--text-secondary)]">Página {{ currentPage }} de {{ totalPages
                    }}</span>
            </div>

            <div class="overflow-x-auto">
                <table class="w-full text-left border-collapse table-fixed">
                    <thead class="bg-[var(--bg-panel)] text-xs text-[var(--text-secondary)] uppercase tracking-wider">
                        <tr>
                            <th class="px-6 py-3 font-medium" style="width: 15%;">Fecha</th>
                            <th class="px-6 py-3 font-medium" style="width: 20%;">Usuario</th>
                            <th class="px-6 py-3 font-medium" style="width: 48%;">Recurso</th>
                            <th class="px-6 py-3 font-medium" style="width: 17%;">Acción</th>
                        </tr>
                    </thead>
                    <tbody class="text-xs text-[var(--text-secondary)] divide-y divide-[var(--border-light)]">
                        @for (log of logs(); track $index) {
                        <tr class="hover:bg-[var(--bg-panel)] transition-colors">
                            <td class="px-6 py-3 text-[var(--text-secondary)] whitespace-nowrap">
                                {{ log.createdAt | date : "dd/MM/yyyy HH:mm" }}
                            </td>

                            <!-- Usuario Column -->
                            <td class="px-6 py-3">
                                @if (log.user) {
                                <div class="flex flex-col">
                                    <span class="text-[var(--text-heading)] font-medium">
                                        {{ log.user.name }}
                                    </span>
                                    <span class="text-xs text-[var(--text-secondary)]">
                                        {{ log.user.email }}
                                    </span>
                                </div>
                                } @else if (log.userName) {
                                <span class="text-white font-medium">
                                    {{ log.userName }}
                                </span>
                                } @else {
                                <span class="bg-[var(--bg-panel)] px-2 py-1 rounded text-xs text-sky-400">
                                    {{ log.userId | slice : 0 : 8 }}...
                                </span>
                                }
                            </td>

                            <!-- Recurso Column -->
                            <td class="px-6 py-3 w-full">
                                @if (log.resource) {
                                @switch (log.resource.type) {
                                @case ('property') {
                                <a [routerLink]="['/properties', log.resource._id]"
                                    class="text-sky-400 hover:text-sky-300 transition-colors flex items-center gap-1 group">
                                    <i class="pi pi-home text-xs"></i>
                                    <span class="truncate">{{ log.resource.title }}</span>
                                    <i
                                        class="pi pi-external-link text-xs opacity-0 group-hover:opacity-100 transition-opacity"></i>
                                </a>
                                }
                                @case ('appointment') {
                                <a [routerLink]="['/dashboard/appointments/edit', log.resource._id]"
                                    class="text-emerald-400 hover:text-emerald-300 transition-colors flex items-center gap-1 group">
                                    <i class="pi pi-calendar text-xs"></i>
                                    <span class="truncate">{{ log.resource.title }}</span>
                                    <i
                                        class="pi pi-external-link text-xs opacity-0 group-hover:opacity-100 transition-opacity"></i>
                                </a>
                                }
                                @case ('user') {
                                <a [routerLink]="['/dashboard/users/edit', log.resource._id]"
                                    class="text-purple-400 hover:text-purple-300 transition-colors flex items-center gap-1 group">
                                    <i class="pi pi-user text-xs"></i>
                                    <span class="truncate">{{ log.resource.title }}</span>
                                    <i
                                        class="pi pi-external-link text-xs opacity-0 group-hover:opacity-100 transition-opacity"></i>
                                </a>
                                }
                                @default {
                                <div class="flex items-center gap-1 text-[var(--text-secondary)]">
                                    <i class="pi pi-question-circle text-xs"></i>
                                    <span class="truncate">{{ log.resource.title || 'Desconocido'
                                        }}</span>
                                </div>
                                }
                                }
                                } @else if (log.resourceId) {
                                <div class="flex items-center gap-1 text-[var(--text-secondary)] italic">
                                    <i class="pi pi-trash text-sm"></i>
                                    <span class="text-xs">Recurso eliminado</span>
                                    <span class="bg-[var(--bg-panel)] px-2 py-1 rounded text-xs">
                                        {{ log.resourceId | slice : 0 : 8 }}...
                                    </span>
                                </div>
                                } @else {
                                <span class="text-[var(--text-secondary)] text-xs">N/A</span>
                                }
                            </td>

                            <!-- Acción Column -->
                            <td class="px-6 py-3">
                                <span
                                    [class]="'px-2 py-1 rounded text-xs font-medium uppercase tracking-wider ' + getActionBadgeClass(log.action)">
                                    {{ getActionLabel(log.action) }}
                                </span>
                            </td>


                        </tr>
                        } @empty {
                        <tr>
                            <td colspan="4" class="px-6 py-8 text-center text-[var(--text-secondary)] italic">
                                No se encontraron registros.
                            </td>
                        </tr>
                        }
                    </tbody>
                </table>
            </div>

            <!-- Pagination -->
            @if (totalPages > 1) {
            <div
                class="px-6 py-4 border-t border-[var(--border-light)] bg-[var(--bg-panel)] flex flex-col sm:flex-row justify-between items-center gap-4">
                <div class="text-xs text-[var(--text-secondary)]">
                    Mostrando <span class="text-[var(--text-heading)] font-bold">{{ (currentPage - 1) * itemsPerPage + 1
                        }}</span> -
                    <span class="text-[var(--text-heading)] font-bold">{{ currentPage * itemsPerPage > totalLogs ?
                        totalLogs :
                        currentPage * itemsPerPage }}</span>
                    de <span class="text-[var(--text-heading)] font-bold">{{ totalLogs }}</span>
                </div>

                <div class="flex items-center gap-2">
                    <button (click)="goToPage(currentPage - 1)" [disabled]="currentPage === 1"
                        class="h-10 px-6 border border-[var(--border-light)] text-xs font-bold uppercase tracking-widest text-[var(--text-secondary)] hover:bg-[var(--bg-panel)] hover:text-[var(--text-heading)] hover:border-sky-500/50 disabled:opacity-30 disabled:cursor-not-allowed disabled:hover:border-white/10 disabled:hover:bg-transparent transition-all">
                        <i class="pi pi-chevron-left mr-2"></i> Anterior
                    </button>

                    <div class="hidden sm:flex items-center gap-1">
                        @for (page of [].constructor(totalPages); track $index; let i = $index) {
                        @if (i + 1 === currentPage || i + 1 === 1 || i + 1 === totalPages || (i + 1 >= currentPage - 1
                        && i + 1 <= currentPage + 1)) { <button (click)="goToPage(i + 1)"
                            [class.bg-sky-500]="currentPage === i + 1" [class.text-white]="currentPage === i + 1"
                            class="h-10 w-10 border border-[var(--border-light)] text-xs font-bold text-[var(--text-secondary)] hover:bg-[var(--bg-panel)] hover:text-[var(--text-heading)] transition-all">
                            {{ i + 1 }}
                            </button>
                            } @else if (i + 1 === currentPage - 2 || i + 1 === currentPage + 2) {
                            <span class="text-[var(--text-secondary)] px-2">...</span>
                            }
                            }
                    </div>

                    <button (click)="goToPage(currentPage + 1)" [disabled]="currentPage === totalPages"
                        class="h-10 px-6 border border-[var(--border-light)] text-sm font-bold uppercase tracking-widest text-[var(--text-secondary)] hover:bg-[var(--bg-panel)] hover:text-[var(--text-heading)] hover:border-sky-500/50 disabled:opacity-30 disabled:cursor-not-allowed disabled:hover:border-white/10 disabled:hover:bg-transparent transition-all">
                        Siguiente <i class="pi pi-chevron-right ml-2"></i>
                    </button>
                </div>
            </div>
            }
        </div>
        }
    </div>
</div>