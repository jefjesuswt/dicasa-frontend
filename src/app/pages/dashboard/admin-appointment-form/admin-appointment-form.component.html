<div class="min-h-screen bg-[var(--bg-dark)] text-[var(--text-primary)] font-sans p-4 md:p-8">
  <!-- Header -->
  <div class="max-w-4xl mx-auto mb-8 border-b border-[var(--border-light)] pb-6">
    <div class="flex items-center gap-3 mb-2">
      <button (click)="cancel()"
        class="group flex items-center justify-center w-8 h-8 rounded-sm text-[var(--text-secondary)] hover:text-[var(--text-heading)] hover:bg-[var(--bg-panel)] transition-all border border-transparent hover:border-[var(--border-light)]"
        title="Volver">
        <i class="pi pi-arrow-left text-sm group-hover:-translate-x-0.5 transition-transform"></i>
      </button>
      <h1 class="text-2xl font-bold text-[var(--text-heading)] uppercase tracking-tight">
        {{ pageTitle }}
      </h1>
    </div>
    <p class="text-sm text-[var(--text-secondary)] ml-11">
      {{
      isEditMode
      ? "GESTIONAR Y ACTUALIZAR ESTADO DE LA CITA."
      : "PROGRAMAR UNA NUEVA CITA."
      }}
    </p>
  </div>

  <!-- Loading State -->
  <div class="transition-opacity duration-300" [class.opacity-50]="initialLoading"
    [class.pointer-events-none]="initialLoading">
    @if (initialLoading) {
    <div class="flex flex-col justify-center items-center py-32 border border-dashed border-[var(--border-light)] rounded-sm">
      <div class="animate-spin rounded-full h-10 w-10 border-t-2 border-b-2 border-sky-500 mb-4"></div>
      <span class="text-[var(--text-secondary)] text-sm animate-pulse tracking-widest uppercase">Cargando Cita...</span>
    </div>
    } @if (!initialLoading && appointmentData) {
    <!-- Card Container -->
    <div class="max-w-4xl mx-auto bg-[var(--bg-dark)] border border-[var(--border-light)] relative shadow-2xl shadow-black/5">
      <!-- Tech Corners -->
      <div class="absolute top-0 left-0 w-3 h-3 border-t border-l border-sky-500"></div>
      <div class="absolute top-0 right-0 w-3 h-3 border-t border-r border-sky-500"></div>
      <div class="absolute bottom-0 left-0 w-3 h-3 border-b border-l border-sky-500"></div>
      <div class="absolute bottom-0 right-0 w-3 h-3 border-b border-r border-sky-500"></div>

      <form [formGroup]="appointmentForm" (ngSubmit)="onSubmit()" class="p-6 md:p-10 space-y-10"
        [class.opacity-50]="isSaving" [class.pointer-events-none]="isSaving">
        <!-- SECCIÓN 1: INFO BÁSICA -->
        <section class="space-y-6">
          <h3
            class="flex items-center gap-2 text-sm font-bold text-sky-500 uppercase tracking-widest border-b border-sky-500/50 pb-2 mb-6">
            <i class="pi pi-info-circle text-sky-500"></i> 01 // Detalles de la Cita
          </h3>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- Cliente Info -->
            <div class="bg-[var(--bg-panel)] border border-[var(--border-light)] p-4 rounded-sm space-y-2">
              <label class="block text-xs font-bold text-[var(--text-secondary)] uppercase tracking-widest">Cliente</label>
              <div class="text-[var(--text-heading)] font-bold uppercase">
                {{ appointmentData.name }}
              </div>
              <div class="text-base text-[var(--text-secondary)] flex items-center gap-2">
                <i class="pi pi-envelope text-xs"></i> {{ appointmentData.email }}
              </div>
              <div class="text-base text-[var(--text-secondary)] flex items-center gap-2">
                <i class="pi pi-phone text-xs"></i> {{ appointmentData.phoneNumber }}
              </div>
            </div>

            <!-- Propiedad Info -->
            <div class="bg-[var(--bg-panel)] border border-[var(--border-light)] p-4 rounded-sm space-y-2">
              <label class="block text-xs font-bold text-[var(--text-secondary)] uppercase tracking-widest">Propiedad de
                Interés</label>
              <a [routerLink]="['/properties', appointmentData.property._id]" target="_blank"
                class="text-sky-400 hover:text-sky-300 hover:underline font-bold flex items-center gap-2 uppercase text-base">
                <i class="pi pi-building"></i>
                {{ appointmentData.property.title }}
                <i class="pi pi-external-link text-sm ml-auto"></i>
              </a>
            </div>

            <!-- Mensaje -->
            <div class="md:col-span-2 bg-[var(--bg-panel)] border border-[var(--border-light)] p-4 rounded-sm space-y-2">
              <label class="block text-xs font-bold text-[var(--text-secondary)] uppercase tracking-widest">Mensaje del
                Cliente</label>
              <p class="text-base text-[var(--text-primary)] italic">
                "{{ appointmentData.message }}"
              </p>
            </div>
          </div>
        </section>

        <!-- SECCIÓN 2: GESTIÓN -->
        <section class="space-y-6">
          <h3
            class="flex items-center gap-2 text-sm font-bold text-violet-500 uppercase tracking-widest border-b border-violet-500/50 pb-2 mb-6">
            <i class="pi pi-cog text-violet-500"></i> 02 // Gestión y Estado
          </h3>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- Agente -->
            <div class="space-y-2">
              <label for="agentId" class="block text-xs font-bold text-[var(--text-secondary)] uppercase tracking-widest">
                Agente Asignado
              </label>
              <select id="agentId" formControlName="agentId"
                class="w-full bg-[var(--bg-dark)] border border-[var(--border-light)] rounded-sm px-4 py-3 text-[var(--text-primary)] focus:outline-none focus:border-sky-500 focus:ring-1 focus:ring-sky-500 text-base disabled:opacity-50"
                [disabled]="agents.length === 0">
                @for (agent of agents; track agent._id) {
                <option [ngValue]="agent._id" class="text-[var(--text-primary)] bg-[var(--bg-dark)]">
                  {{ agent.name }}
                </option>
                }
              </select>
              <p class="text-xs text-[var(--text-secondary)] mt-1">
                * Reasignar verificará disponibilidad del nuevo agente.
              </p>
            </div>

            <!-- Estado -->
            <div class="space-y-2">
              <label for="status" class="block text-xs font-bold text-[var(--text-secondary)] uppercase tracking-widest">
                Estado Actual
              </label>
              <select id="status" formControlName="status"
                class="w-full bg-[var(--bg-dark)] border border-[var(--border-light)] rounded-sm px-4 py-3 text-[var(--text-primary)] focus:outline-none focus:border-sky-500 focus:ring-1 focus:ring-sky-500 text-base">
                @for (opt of statusOptions; track opt.value) {
                <option [value]="opt.value" class="text-[var(--text-primary)] bg-[var(--bg-dark)]">
                  {{ opt.label }}
                </option>
                }
              </select>
            </div>

            <!-- Fecha -->
            <div class="md:col-span-2 space-y-2">
              <label for="appointmentDate" class="block text-xs font-bold text-[var(--text-secondary)] uppercase tracking-widest">
                Fecha y Hora Programada
              </label>
              <div class="custom-datepicker-dark">
                <app-custom-datepicker id="appointmentDate" formControlName="appointmentDate" [minDate]="minDate"
                  placeholder="Selecciona fecha y hora">
                </app-custom-datepicker>
              </div>
              @if (appointmentForm.get('appointmentDate')?.invalid &&
              appointmentForm.get('appointmentDate')?.touched) {
              <p class="text-xs text-red-400 uppercase mt-1">
                La fecha es requerida.
              </p>
              }
            </div>
          </div>
        </section>

        <!-- Footer Actions -->
        <div class="pt-6 border-t border-[var(--border-light)] flex justify-end gap-3">
          <button type="button" (click)="cancel()" [disabled]="isSaving"
            class="px-6 py-3 text-xs font-bold uppercase tracking-widest text-[var(--text-secondary)] hover:text-[var(--text-heading)] border border-transparent hover:border-[var(--border-light)] rounded-sm transition-all">
            Cancelar
          </button>

          <button type="submit" [disabled]="
              appointmentForm.invalid || isSaving || appointmentForm.pristine
            "
            class="px-8 py-3 bg-sky-600 hover:bg-sky-500 text-white text-xs font-bold uppercase tracking-widest rounded-sm shadow-[0_0_15px_rgba(2,132,199,0.3)] hover:shadow-[0_0_20px_rgba(2,132,199,0.5)] disabled:opacity-50 disabled:shadow-none disabled:cursor-not-allowed transition-all flex items-center gap-2">
            @if (isSaving) {
            <i class="pi pi-spin pi-spinner"></i>
            <span>Guardando...</span>
            } @else {
            <i class="pi pi-check"></i>
            <span>Guardar Cambios</span>
            }
          </button>
        </div>
      </form>
    </div>
    }
  </div>
</div>
