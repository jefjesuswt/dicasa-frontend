<div class="min-h-screen bg-[var(--bg-dark)] text-[var(--text-primary)] font-sans p-4 md:p-8">

  <!-- Header -->
  <div class="max-w-4xl mx-auto mb-8 border-b border-[var(--border-light)] pb-6">
    <div class="flex items-center gap-3 mb-2">
      <button
        (click)="cancel()"
        class="group flex items-center justify-center w-8 h-8 rounded-sm text-[var(--text-secondary)] hover:text-[var(--text-heading)] hover:bg-[var(--bg-panel)] transition-all border border-transparent hover:border-[var(--border-light)]"
        title="Cancelar y Volver"
      >
        <i class="pi pi-arrow-left text-sm group-hover:-translate-x-0.5 transition-transform"></i>
      </button>
      <h1 class="text-2xl font-bold text-[var(--text-heading)] uppercase tracking-tight">
        {{ pageTitle }}
      </h1>
    </div>
    <p class="text-sm text-[var(--text-secondary)] ml-11">
      {{ isEditMode ? 'ACTUALIZAR FICHA TÉCNICA Y DETALLES DEL INMUEBLE.' : 'FORMULARIO DE INGRESO AL INVENTARIO DE PROPIEDADES.' }}
    </p>
  </div>

  <!-- Loading State -->
  <div
    class="transition-opacity duration-300"
    [class.opacity-50]="initialLoading"
    [class.pointer-events-none]="initialLoading"
  >
    @if (initialLoading) {
      <div class="flex flex-col justify-center items-center py-32 border border-dashed border-[var(--border-light)] rounded-sm">
        <div class="animate-spin rounded-full h-10 w-10 border-t-2 border-b-2 border-sky-500 mb-4"></div>
        <span class="text-[var(--text-secondary)] text-sm animate-pulse tracking-widest uppercase">Cargando Inmueble...</span>
      </div>
    } @if (!initialLoading) {

      <!-- Card Container -->
      <div class="max-w-4xl mx-auto bg-[var(--bg-dark)] border border-[var(--border-light)] relative shadow-2xl shadow-black/5">

        <!-- Tech Corners -->
        <div class="absolute top-0 left-0 w-3 h-3 border-t border-l border-sky-500"></div>
        <div class="absolute top-0 right-0 w-3 h-3 border-t border-r border-sky-500"></div>
        <div class="absolute bottom-0 left-0 w-3 h-3 border-b border-l border-sky-500"></div>
        <div class="absolute bottom-0 right-0 w-3 h-3 border-b border-r border-sky-500"></div>

        <form
          [formGroup]="propertyForm"
          (ngSubmit)="onSubmit()"
          class="p-6 md:p-10 space-y-10"
          [class.opacity-50]="isSaving"
          [class.pointer-events-none]="isSaving"
        >
          <!-- SECCIÓN 1: INFO BÁSICA -->
          <section class="space-y-6">
            <h3 class="flex items-center gap-2 text-sm font-bold text-emerald-500 uppercase tracking-widest border-b border-emerald-500/50 pb-2 mb-6">
              <i class="pi pi-file"></i> 01 // Información Básica
            </h3>

            <!-- Agente -->
            <div class="bg-[var(--bg-panel)] border border-[var(--border-light)] p-4 rounded-sm">
               <label for="agent" class="block text-xs font-bold text-[var(--text-secondary)] uppercase tracking-widest mb-2">
                 Agente Asignado <span class="text-red-500">*</span>
               </label>
               <select
                 id="agent"
                 formControlName="agent"
                 class="w-full bg-[var(--bg-dark)] border border-[var(--border-light)] rounded-sm px-4 py-3 text-[var(--text-primary)] placeholder-[var(--text-secondary)] focus:outline-none focus:border-sky-500 focus:ring-1 focus:ring-sky-500 transition-all text-sm disabled:opacity-50"
                 [class.border-red-500]="propertyForm.get('agent')?.invalid && propertyForm.get('agent')?.touched"
               >
                 <option [ngValue]="null" disabled class="text-[var(--text-secondary)]">
                   {{ agents.length > 0 ? "SELECCIONE AGENTE..." : "SIN AGENTES DISPONIBLES" }}
                 </option>
                 @for (agent of agents; track agent._id) {
                   <option [ngValue]="agent._id" class="text-[var(--text-heading)]">{{ agent.name }}</option>
                 }
               </select>
               @if (propertyForm.get('agent')?.invalid && propertyForm.get('agent')?.touched) {
                 <p class="text-xs text-red-400 uppercase mt-1">Requerido</p>
               }
            </div>

            <!-- Título y Precio -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div class="space-y-2">
                <label for="title" class="block text-xs font-bold text-[var(--text-secondary)] uppercase tracking-widest">
                  Título del Inmueble <span class="text-red-500">*</span>
                </label>
                <input
                  id="title"
                  type="text"
                  formControlName="title"
                  class="w-full bg-[var(--bg-dark)] border border-[var(--border-light)] rounded-sm px-4 py-3 text-[var(--text-primary)] placeholder-[var(--text-secondary)] focus:outline-none focus:border-sky-500 focus:ring-1 focus:ring-sky-500 transition-all text-base"
                  placeholder="Ej. Casa Moderna en Lechería"
                />
                @if (propertyForm.get('title')?.invalid && propertyForm.get('title')?.touched) {
                  <p class="text-xs text-red-400 uppercase mt-1">Requerido (Mín. 5 chars)</p>
                }
              </div>

              <div class="space-y-2">
                <label for="price" class="block text-xs font-bold text-[var(--text-secondary)] uppercase tracking-widest">
                  Precio (USD) <span class="text-red-500">*</span>
                </label>
                <div class="relative">
                   <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                     <span class="text-[var(--text-secondary)]">$</span>
                   </div>
                   <input
                     id="price"
                     type="number"
                     formControlName="price"
                     class="w-full bg-[var(--bg-dark)] border border-[var(--border-light)] rounded-sm pl-8 pr-4 py-3 text-[var(--text-primary)] placeholder-[var(--text-secondary)] focus:outline-none focus:border-sky-500 focus:ring-1 focus:ring-sky-500 transition-all text-base"
                     placeholder="0.00"
                   />
                </div>
                @if (propertyForm.get('price')?.invalid && propertyForm.get('price')?.touched) {
                  <p class="text-xs text-red-400 uppercase mt-1">Requerido (> 0)</p>
                }
              </div>
            </div>

            <!-- Tipo y Estatus -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div class="space-y-2">
                <label for="type" class="block text-xs font-bold text-[var(--text-secondary)] uppercase tracking-widest">
                  Tipo de Inmueble <span class="text-red-500">*</span>
                </label>
                <select
                  id="type"
                  formControlName="type"
                  class="w-full bg-[var(--bg-dark)] border border-[var(--border-light)] rounded-sm px-4 py-3 text-[var(--text-primary)] focus:outline-none focus:border-sky-500 focus:ring-1 focus:ring-sky-500 text-base"
                >
                  <option value="house">CASA</option>
                  <option value="apartment">DEPARTAMENTO</option>
                  <option value="land">TERRENO</option>
                  <option value="commercial">LOCAL COMERCIAL</option>
                  <option value="villa">VILLA</option>
                </select>
              </div>

              <div class="space-y-2">
                <label for="status" class="block text-xs font-bold text-[var(--text-secondary)] uppercase tracking-widest">
                  Estatus Comercial <span class="text-red-500">*</span>
                </label>
                <select
                  id="status"
                  formControlName="status"
                  class="w-full bg-[var(--bg-dark)] border border-[var(--border-light)] rounded-sm px-4 py-3 text-[var(--text-primary)] focus:outline-none focus:border-sky-500 focus:ring-1 focus:ring-sky-500 text-base"
                >
                  <option value="sale">EN VENTA</option>
                  <option value="rent">EN ALQUILER</option>
                  @if (isEditMode) {
                    <option value="sold">VENDIDO</option>
                    <option value="rented">ALQUILADO</option>
                  }
                </select>
              </div>
            </div>

            <!-- Descripción -->
            <div class="space-y-2">
               <label for="description" class="block text-xs font-bold text-[var(--text-secondary)] uppercase tracking-widest">
                  Descripción Detallada <span class="text-red-500">*</span>
                </label>
                <textarea
                  id="description"
                  formControlName="description"
                  rows="4"
                  class="w-full bg-[var(--bg-dark)] border border-[var(--border-light)] rounded-sm px-4 py-3 text-[var(--text-primary)] placeholder-[var(--text-secondary)] focus:outline-none focus:border-sky-500 focus:ring-1 focus:ring-sky-500 transition-all text-base"
                  placeholder="Describa las características principales..."
                ></textarea>
                @if (propertyForm.get('description')?.invalid && propertyForm.get('description')?.touched) {
                  <p class="text-xs text-red-400 uppercase mt-1">Requerido (Mín. 20 chars)</p>
                }
            </div>
          </section>

          <!-- SECCIÓN 2: DETALLES -->
          <section class="space-y-6">
            <h3 class="flex items-center gap-2 text-sm font-bold text-violet-500 uppercase tracking-widest border-b border-violet-500/50 pb-2 mb-6">
              <i class="pi pi-sliders-h"></i> 02 // Especificaciones
            </h3>

            <div class="grid grid-cols-1 sm:grid-cols-3 gap-6">
               @if (isResidentialType) {
                 <div class="space-y-2">
                   <label for="bedrooms" class="block text-xs font-bold text-[var(--text-secondary)] uppercase tracking-widest">Habitaciones</label>
                   <input
                     id="bedrooms"
                     type="number"
                     formControlName="bedrooms"
                     min="0"
                     class="w-full bg-[var(--bg-dark)] border border-[var(--border-light)] rounded-sm px-4 py-3 text-[var(--text-primary)] focus:border-sky-500 text-base"
                   />
                 </div>
                 <div class="space-y-2">
                    <label for="bathrooms" class="block text-xs font-bold text-[var(--text-secondary)] uppercase tracking-widest">Baños</label>
                    <input
                      id="bathrooms"
                      type="number"
                      formControlName="bathrooms"
                      min="0"
                       class="w-full bg-[var(--bg-dark)] border border-[var(--border-light)] rounded-sm px-4 py-3 text-[var(--text-primary)] focus:border-sky-500 text-base"
                    />
                 </div>
               } @else {
                  <div class="hidden sm:block sm:col-span-2 p-4 border border-dashed border-[var(--border-light)] rounded-sm flex items-center justify-center">
                    <span class="text-xs text-[var(--text-secondary)] uppercase">Opciones residenciales no aplican</span>
                  </div>
               }

               <div class="space-y-2">
                 <label for="area" class="block text-xs font-bold text-[var(--text-secondary)] uppercase tracking-widest">Área Total (m²)</label>
                 <input
                   id="area"
                   type="number"
                   formControlName="area"
                   min="1"
                   class="w-full bg-[var(--bg-dark)] border border-[var(--border-light)] rounded-sm px-4 py-3 text-[var(--text-primary)] focus:border-sky-500 text-base"
                 />
               </div>
            </div>
          </section>

          <!-- SECCIÓN 3: UBICACIÓN -->
          <section formGroupName="address" class="space-y-6">
            <h3 class="flex items-center gap-2 text-sm font-bold text-amber-500 uppercase tracking-widest border-b border-amber-500/50 pb-2 mb-6">
              <i class="pi pi-map"></i> 03 // Ubicación Geográfica
            </h3>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div class="md:col-span-2 space-y-2">
                 <label for="address-address" class="block text-xs font-bold text-[var(--text-secondary)] uppercase tracking-widest">Dirección Exacta</label>
                <input
                  id="address-address"
                  type="text"
                  formControlName="address"
                   class="w-full bg-[var(--bg-dark)] border border-[var(--border-light)] rounded-sm px-4 py-3 text-[var(--text-primary)] placeholder-[var(--text-secondary)] focus:outline-none focus:border-sky-500 text-base"
                  placeholder="Av. Principal, Edificio X, Piso Y..."
                />
              </div>

              <div class="space-y-2">
                 <label for="address-state" class="block text-xs font-bold text-[var(--text-secondary)] uppercase tracking-widest">Estado</label>
                <select
                  id="address-state"
                  formControlName="state"
                   class="w-full bg-[var(--bg-dark)] border border-[var(--border-light)] rounded-sm px-4 py-3 text-[var(--text-primary)] focus:outline-none focus:border-sky-500 text-base"
                >
                  <option value="" disabled class="text-[var(--text-secondary)]">SELECCIONE ESTADO...</option>
                  @for (state of states; track state.state) {
                    <option [value]="state.state" class="text-[var(--text-heading)]">{{ state.state }}</option>
                  }
                </select>
                @if (propertyForm.get('address.state')?.invalid && propertyForm.get('address.state')?.touched) {
                  <p class="text-xs text-red-400 uppercase mt-1">Requerido</p>
                }
              </div>

              <div class="space-y-2">
                 <label for="address-city" class="block text-xs font-bold text-[var(--text-secondary)] uppercase tracking-widest">Ciudad / Municipio</label>
                <select
                  id="address-city"
                  formControlName="city"
                  [disabled]="isLoadingCities || cities.length === 0"
                   class="w-full bg-[var(--bg-dark)] border border-[var(--border-light)] rounded-sm px-4 py-3 text-[var(--text-primary)] focus:outline-none focus:border-sky-500 text-base disabled:opacity-50"
                >
                  <option value="" disabled class="text-[var(--text-secondary)]">
                    {{ isLoadingCities ? "CARGANDO..." : "SELECCIONE CIUDAD..." }}
                  </option>
                  @for (city of cities; track city) {
                    <option [value]="city" class="text-[var(--text-heading)]">{{ city }}</option>
                  }
                </select>
                @if (propertyForm.get('address.city')?.invalid && propertyForm.get('address.city')?.touched) {
                  <p class="text-xs text-red-400 uppercase mt-1">Requerido</p>
                }
              </div>
            </div>
          </section>

          <!-- SECCIÓN 4: AMENIDADES -->
          <section formGroupName="features" class="space-y-6">
            <h3 class="flex items-center gap-2 text-sm font-bold text-fuchsia-500 uppercase tracking-widest border-b border-fuchsia-500/50 pb-2 mb-6">
               <i class="pi pi-star"></i> 04 // Amenidades y Servicios
            </h3>

            <div class="grid grid-cols-2 sm:grid-cols-3 gap-4">
              <!-- Checkbox Item -->
              <div class="flex items-center p-3 bg-[var(--bg-panel)] border border-[var(--border-light)] rounded-sm hover:border-sky-500/30 transition-colors">
                <input
                  id="features-parking"
                  type="checkbox"
                  formControlName="hasParking"
                  class="h-4 w-4 bg-[var(--bg-dark)] border-[var(--text-secondary)] rounded text-sky-600 focus:ring-0 cursor-pointer"
                />
                 <label for="features-parking" class="ml-3 block text-sm font-bold text-[var(--text-primary)] uppercase cursor-pointer">Estacionamiento</label>
              </div>

              <div class="flex items-center p-3 bg-[var(--bg-panel)] border border-[var(--border-light)] rounded-sm hover:border-sky-500/30 transition-colors">
                <input
                  id="features-furniture"
                  type="checkbox"
                  formControlName="hasFurniture"
                  class="h-4 w-4 bg-[var(--bg-dark)] border-[var(--text-secondary)] rounded text-sky-600 focus:ring-0 cursor-pointer"
                />
                 <label for="features-furniture" class="ml-3 block text-sm font-bold text-[var(--text-primary)] uppercase cursor-pointer">Amoblado</label>
              </div>

              <div class="flex items-center p-3 bg-[var(--bg-panel)] border border-[var(--border-light)] rounded-sm hover:border-sky-500/30 transition-colors">
                <input
                  id="features-pool"
                  type="checkbox"
                  formControlName="hasPool"
                  class="h-4 w-4 bg-[var(--bg-dark)] border-[var(--text-secondary)] rounded text-sky-600 focus:ring-0 cursor-pointer"
                />
                 <label for="features-pool" class="ml-3 block text-sm font-bold text-[var(--text-primary)] uppercase cursor-pointer">Piscina</label>
              </div>

              <div class="flex items-center p-3 bg-[var(--bg-panel)] border border-[var(--border-light)] rounded-sm hover:border-sky-500/30 transition-colors">
                <input
                  id="features-garden"
                  type="checkbox"
                  formControlName="hasGarden"
                  class="h-4 w-4 bg-[var(--bg-dark)] border-[var(--text-secondary)] rounded text-sky-600 focus:ring-0 cursor-pointer"
                />
                 <label for="features-garden" class="ml-3 block text-sm font-bold text-[var(--text-primary)] uppercase cursor-pointer">Jardín</label>
              </div>

              <div class="flex items-center p-3 bg-[var(--bg-panel)] border border-[var(--border-light)] rounded-sm hover:border-sky-500/30 transition-colors">
                <input
                  id="features-pets"
                  type="checkbox"
                  formControlName="isPetFriendly"
                  class="h-4 w-4 bg-[var(--bg-dark)] border-[var(--text-secondary)] rounded text-sky-600 focus:ring-0 cursor-pointer"
                />
                 <label for="features-pets" class="ml-3 block text-sm font-bold text-[var(--text-primary)] uppercase cursor-pointer">Mascotas OK</label>
              </div>
            </div>
          </section>

          <!-- SECCIÓN 5: IMÁGENES -->
          <section class="space-y-6">
            <h3 class="flex items-center gap-2 text-sm font-bold text-sky-500 uppercase tracking-widest border-b border-sky-500/50 pb-2 mb-6">
               <i class="pi pi-images"></i> 05 // Galería Multimedia
            </h3>

            <!-- Upload Area -->
             <div class="border-2 border-dashed border-[var(--border-light)] rounded-sm p-6 hover:border-sky-500/30 hover:bg-sky-500/5 transition-all text-center">
                 <input
                  id="file-upload"
                  type="file"
                  multiple
                  (change)="onFileSelect($event)"
                  class="hidden"
                  accept="image/png, image/jpeg, image/webp"
                  [disabled]="isSaving"
                  #fileInput
                />
                <div class="flex flex-col items-center gap-2 cursor-pointer" (click)="fileInput.click()">
                   <i class="pi pi-cloud-upload text-3xl text-[var(--text-secondary)]"></i>
                   <p class="text-sm font-bold text-[var(--text-heading)] uppercase">{{ isEditMode ? "AGREGAR NUEVAS IMÁGENES" : "SUBIR IMÁGENES" }}</p>
                   <p class="text-xs text-[var(--text-secondary)]">JPG, PNG, WEBP (Max 5MB)</p>
                </div>
                 @if (isUploadingImages) {
                    <p class="mt-4 text-xs text-sky-400 animate-pulse">
                      <i class="pi pi-spin pi-spinner mr-2"></i> Procesando subida...
                    </p>
                 }
             </div>

             <!-- Grid Imágenes Existentes -->
             @if (isEditMode && existingImageUrls.length > 0) {
              <div class="space-y-2">
                <p class="text-[10px] font-bold text-[var(--text-secondary)] uppercase tracking-widest">Galería Actual</p>
                <div class="grid grid-cols-2 sm:grid-cols-4 md:grid-cols-6 gap-4">
                  @for (url of existingImageUrls; track $index) {
                    <div class="relative group aspect-square bg-[var(--bg-dark)] border border-[var(--border-light)] rounded-sm overflow-hidden">
                       <img [src]="url" class="w-full h-full object-cover opacity-70 group-hover:opacity-100 transition-opacity">
                       <button
                         type="button"
                         (click)="removeExistingImage($index)"
                         class="absolute inset-0 flex items-center justify-center bg-black/60 opacity-0 group-hover:opacity-100 transition-opacity text-red-500"
                         [disabled]="isSaving"
                       >
                         <i class="pi pi-trash text-xl"></i>
                       </button>
                    </div>
                  }
                </div>
              </div>
             }

             <!-- Grid Nuevas Imágenes -->
             @if (imagePreviews.length > 0) {
               <div class="space-y-2 pt-4 border-t border-[var(--border-light)]">
                 <p class="text-[10px] font-bold text-sky-500 uppercase tracking-widest">Listo para subir ({{ imagePreviews.length }})</p>
                 <div class="grid grid-cols-2 sm:grid-cols-4 md:grid-cols-6 gap-4">
                   @for (preview of imagePreviews; track $index) {
                     <div class="relative group aspect-square bg-[var(--bg-dark)] border border-sky-500/30 rounded-sm overflow-hidden">
                        <img [src]="preview" class="w-full h-full object-cover">
                        <button
                          type="button"
                          (click)="removeSelectedFile($index)"
                          class="absolute top-1 right-1 bg-slate-950 text-red-500 rounded-sm p-1 hover:bg-white transition-colors"
                          [disabled]="isSaving"
                        >
                          <i class="pi pi-times"></i>
                        </button>
                     </div>
                   }
                 </div>
               </div>
             }
          </section>

          <!-- Featured Switch -->
          <div class="py-6 border-t border-[var(--border-light)] flex items-center">
             <div class="flex items-center h-5">
                <input
                  id="featured"
                  type="checkbox"
                  formControlName="featured"
                  class="w-4 h-4 bg-[var(--bg-dark)] border-[var(--border-light)] rounded text-yellow-500 focus:ring-0 cursor-pointer"
                />
             </div>
             <div class="ml-3">
               <label for="featured" class="text-sm font-bold text-[var(--text-heading)] uppercase tracking-wide cursor-pointer hover:text-yellow-400 transition-colors">Marcar como Destacado</label>
               <p class="text-[var(--text-secondary)] text-xs mt-0.5">Aparecerá en el carrusel principal del Home.</p>
             </div>
          </div>

          <!-- Footer Actions -->
          <div class="pt-6 border-t border-[var(--border-light)] flex justify-end gap-3">
             <button
                type="button"
                (click)="cancel()"
                [disabled]="isSaving"
                class="px-6 py-3 text-xs font-bold uppercase tracking-widest text-[var(--text-secondary)] hover:text-[var(--text-heading)] border border-transparent hover:border-[var(--border-light)] rounded-sm transition-all"
             >
               Cancelar
             </button>

             <button
                type="submit"
                [disabled]="propertyForm.invalid || isSaving || propertyForm.pristine"
                class="px-8 py-3 bg-sky-600 hover:bg-sky-500 text-white text-xs font-bold uppercase tracking-widest rounded-sm shadow-[0_0_15px_rgba(2,132,199,0.3)] hover:shadow-[0_0_20px_rgba(2,132,199,0.5)] disabled:opacity-50 disabled:shadow-none disabled:cursor-not-allowed transition-all flex items-center gap-2"
             >
                @if (isSaving) {
                  <i class="pi pi-spin pi-spinner"></i>
                  <span>Guardando...</span>
                } @else {
                  <i class="pi pi-check"></i>
                  <span>{{ isEditMode ? "Actualizar Ficha" : "Registrar Propiedad" }}</span>
                }
             </button>
          </div>
        </form>
      </div>
    }
  </div>
</div>
